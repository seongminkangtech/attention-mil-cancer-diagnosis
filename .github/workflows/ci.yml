name: CI - ì§€ì†ì  í†µí•©

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.10"
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ env.PYTHON_VERSION }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black flake8 mypy isort
    
    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      run: |
        echo "ğŸ” Blackìœ¼ë¡œ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì¤‘..."
        black --check --diff src/ scripts/ tests/
    
    - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
      run: |
        echo "ğŸ” isortìœ¼ë¡œ import ì •ë ¬ ê²€ì‚¬ ì¤‘..."
        isort --check-only --diff src/ scripts/ tests/
    
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Flake8)
      run: |
        echo "ğŸ” Flake8ìœ¼ë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
        flake8 src/ scripts/ tests/ --max-line-length=88 --extend-ignore=E203,W503
    
    - name: íƒ€ì… ì²´í¬ (MyPy)
      run: |
        echo "ğŸ” MyPyë¡œ íƒ€ì… ì²´í¬ ì¤‘..."
        mypy src/ --ignore-missing-imports --no-strict-optional

  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ env.PYTHON_VERSION }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        pytest tests/ -v
    
    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
      run: |
        echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        pytest tests/unit/ -v
    
    - name: í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
      run: |
        echo "ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        pytest tests/integration/ -v

  security:
    name: ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ env.PYTHON_VERSION }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install safety bandit
    
    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        echo "ğŸ”’ ì˜ì¡´ì„± ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
        safety check --json --output safety-report.json || true
    
    - name: ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
      run: |
        echo "ğŸ”’ ì½”ë“œ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
        bandit -r src/ -f json -o bandit-report.json || true
    
    - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  build:
    name: ë¹Œë“œ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [code-quality, test, security]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ env.PYTHON_VERSION }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¤‘..."
        docker build -t attention-mil:test .
    
    - name: ONNX ë³€í™˜ í…ŒìŠ¤íŠ¸
      run: |
        echo "âš¡ ONNX ë³€í™˜ í…ŒìŠ¤íŠ¸ ì¤‘..."
        python scripts/onnx_tools.py --validate --onnx_path models/model.onnx || echo "ONNX ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. í•™ìŠµ í›„ ìƒì„±ë©ë‹ˆë‹¤."

  notify:
    name: ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [code-quality, test, security, build]
    if: always()
    
    steps:
    - name: CI ê²°ê³¼ ì•Œë¦¼
      run: |
        if [ "${{ needs.code-quality.result }}" == "success" ] && \
           [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.security.result }}" == "success" ] && \
           [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… ëª¨ë“  CI ë‹¨ê³„ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
        else
          echo "âŒ ì¼ë¶€ CI ë‹¨ê³„ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"
        fi 