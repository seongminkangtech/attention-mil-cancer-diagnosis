name: ëª¨ë¸ í•™ìŠµ ë° ê²€ì¦

on:
  schedule:
    - cron: '0 2 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 2ì‹œ
  workflow_dispatch:
    inputs:
      experiment_name:
        description: 'ì‹¤í—˜ ì´ë¦„'
        required: false
        default: 'attention-mil-weekly-training'
      config_file:
        description: 'ì„¤ì • íŒŒì¼ ê²½ë¡œ'
        required: false
        default: 'configs/model_configs/attention_mil.yaml'
      force_retrain:
        description: 'ê°•ì œ ìž¬í•™ìŠµ'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}

jobs:
  prepare-environment:
    name: í•™ìŠµ í™˜ê²½ ì¤€ë¹„
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9, 3.10, 3.11]
    outputs:
      should-train: ${{ steps.check.outputs.should-train }}
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install mlflow
    
    - name: í•™ìŠµ í•„ìš”ì„± í™•ì¸
      id: check
      run: |
        echo "ðŸ” í•™ìŠµ í•„ìš”ì„± í™•ì¸ ì¤‘..."
        
        # MLflowì—ì„œ ìµœê·¼ ëª¨ë¸ ì„±ëŠ¥ í™•ì¸
        if [ "${{ github.event.inputs.force_retrain }}" == "true" ]; then
          echo "should-train=true" >> $GITHUB_OUTPUT
          echo "ê°•ì œ ìž¬í•™ìŠµì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤."
          exit 0
        fi
        
        # ìµœê·¼ ëª¨ë¸ê³¼ ë¹„êµí•˜ì—¬ ì„±ëŠ¥ ê°œì„  ì—¬ë¶€ íŒë‹¨
        python scripts/check_training_needs.py \
          --baseline-accuracy 0.89 \
          --improvement-threshold 0.02 \
          --days-since-last-training 7
        
        if [ $? -eq 0 ]; then
          echo "should-train=true" >> $GITHUB_OUTPUT
          echo "í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤."
        else
          echo "should-train=false" >> $GITHUB_OUTPUT
          echo "í˜„ìž¬ ëª¨ë¸ì´ ì¶©ë¶„ížˆ ì¢‹ìŠµë‹ˆë‹¤. í•™ìŠµì„ ê±´ë„ˆëœë‹ˆë‹¤."
        fi

  train-model:
    name: ëª¨ë¸ í•™ìŠµ
    runs-on: ubuntu-latest
    needs: prepare-environment
    if: needs.prepare-environment.outputs.should-train == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9, 3.10, 3.11]
    outputs:
      model-version: ${{ steps.train.outputs.version }}
      model-path: ${{ steps.train.outputs.model-path }}
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install mlflow
    
    - name: MLflow ì„¤ì •
      run: |
        echo "ðŸ“Š MLflow ì„¤ì • ì¤‘..."
        mlflow set_tracking_uri ${{ env.MLFLOW_TRACKING_URI }}
        mlflow set_experiment ${{ github.event.inputs.experiment_name || 'attention-mil-weekly-training' }}
    
    - name: ëª¨ë¸ í•™ìŠµ ì‹¤í–‰
      id: train
      run: |
        echo "ðŸš€ ëª¨ë¸ í•™ìŠµ ì‹œìž‘..."
        
        # í•™ìŠµ ì‹œìž‘ ì‹œê°„ ê¸°ë¡
        start_time=$(date +%s)
        
        # ëª¨ë¸ í•™ìŠµ ì‹¤í–‰
        python scripts/train.py \
          --config ${{ github.event.inputs.config_file || 'configs/model_configs/attention_mil.yaml' }} \
          --experiment_name ${{ github.event.inputs.experiment_name || 'attention-mil-weekly-training' }}
        
        # í•™ìŠµ ì™„ë£Œ ì‹œê°„ ê¸°ë¡
        end_time=$(date +%s)
        training_time=$((end_time - start_time))
        
        # ëª¨ë¸ ë²„ì „ ìƒì„±
        model_version=$(date +%Y%m%d_%H%M%S)
        echo "version=$model_version" >> $GITHUB_OUTPUT
        echo "model-path=models/best_model_${model_version}.pth" >> $GITHUB_OUTPUT
        
        echo "âœ… ëª¨ë¸ í•™ìŠµ ì™„ë£Œ!"
        echo "í•™ìŠµ ì‹œê°„: ${training_time}ì´ˆ"
        echo "ëª¨ë¸ ë²„ì „: ${model_version}"
    
    - name: í•™ìŠµ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: trained-model-${{ steps.train.outputs.version }}
        path: |
          models/
          mlruns/
        retention-days: 30

  validate-model:
    name: ëª¨ë¸ ê²€ì¦
    runs-on: ubuntu-latest
    needs: train-model
    if: needs.prepare-environment.outputs.should-train == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ëª¨ë¸ ì„±ëŠ¥ ê²€ì¦
      run: |
        echo "ðŸ” ëª¨ë¸ ì„±ëŠ¥ ê²€ì¦ ì¤‘..."
        
        # ìƒˆë¡œ í•™ìŠµëœ ëª¨ë¸ì˜ ì„±ëŠ¥ í‰ê°€
        python scripts/validate_model.py \
          --model_path ${{ needs.train-model.outputs.model-path }} \
          --test_data_path data/test/ \
          --baseline_accuracy 0.89 \
          --min_improvement 0.01
        
        if [ $? -eq 0 ]; then
          echo "âœ… ëª¨ë¸ ê²€ì¦ í†µê³¼!"
        else
          echo "âŒ ëª¨ë¸ ê²€ì¦ ì‹¤íŒ¨ - ì„±ëŠ¥ ê¸°ì¤€ì„ ë§Œì¡±í•˜ì§€ ëª»í•©ë‹ˆë‹¤."
          exit 1
        fi
    
    - name: ONNX ë³€í™˜
      run: |
        echo "âš¡ ONNX ë³€í™˜ ì¤‘..."
        python scripts/onnx_tools.py \
          --convert \
          --model_path ${{ needs.train-model.outputs.model-path }} \
          --onnx_path models/model_${{ needs.train-model.outputs.version }}.onnx
    
    - name: ONNX ëª¨ë¸ ê²€ì¦
      run: |
        echo "ðŸ” ONNX ëª¨ë¸ ê²€ì¦ ì¤‘..."
        python scripts/onnx_tools.py \
          --validate \
          --onnx_path models/model_${{ needs.train-model.outputs.version }}.onnx

  register-model:
    name: ëª¨ë¸ ë“±ë¡ ë° ë²„ì „ ê´€ë¦¬
    runs-on: ubuntu-latest
    needs: [train-model, validate-model]
    if: needs.prepare-environment.outputs.should-train == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install mlflow
    
    - name: MLflow ëª¨ë¸ ë“±ë¡
      run: |
        echo "ðŸ“Š MLflowì— ëª¨ë¸ ë“±ë¡ ì¤‘..."
        
        # ëª¨ë¸ì„ MLflow ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë“±ë¡
        mlflow models register \
          -r mlruns/0/*/artifacts/model \
          --name "attention-mil-cancer-diagnosis" \
          --version ${{ needs.train-model.outputs.version }}
        
        echo "âœ… ëª¨ë¸ì´ MLflowì— ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."
    
    - name: ëª¨ë¸ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
      run: |
        echo "ðŸ“ ëª¨ë¸ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."
        
        # ëª¨ë¸ ì •ë³´ë¥¼ JSON íŒŒì¼ë¡œ ì €ìž¥
        cat > models/model_info_${{ needs.train-model.outputs.version }}.json << EOF
        {
          "version": "${{ needs.train-model.outputs.version }}",
          "training_date": "$(date -Iseconds)",
          "commit_sha": "${{ github.sha }}",
          "experiment_name": "${{ github.event.inputs.experiment_name || 'attention-mil-weekly-training' }}",
          "model_path": "${{ needs.train-model.outputs.model-path }}",
          "onnx_path": "models/model_${{ needs.train-model.outputs.version }}.onnx",
          "performance_metrics": {
            "accuracy": "0.89+",
            "auc": "0.89+",
            "f1_score": "0.88+"
          }
        }
        EOF

  # ìƒˆ ëª¨ë¸ ë°°í¬ëŠ” ì œê±° (ìŠ¤í…Œì´ì§•ê¹Œì§€ë§Œ êµ¬ì„±)
  # deploy-model job removed

  notify:
    name: í•™ìŠµ ê²°ê³¼ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [prepare-environment, train-model, validate-model, register-model]
    if: always()
    
    steps:
    - name: í•™ìŠµ ê²°ê³¼ ìš”ì•½
      run: |
        echo "ðŸ“Š ëª¨ë¸ í•™ìŠµ ê²°ê³¼ ìš”ì•½"
        echo "========================"
        
        if [ "${{ needs.prepare-environment.outputs.should-train }}" == "true" ]; then
          echo "í•™ìŠµ ì‹¤í–‰: âœ…"
          echo "ëª¨ë¸ ë²„ì „: ${{ needs.train-model.outputs.version || 'N/A' }}"
          echo "ëª¨ë¸ ê²€ì¦: ${{ needs.validate-model.result || 'N/A' }}"
          echo "ëª¨ë¸ ë“±ë¡: ${{ needs.register-model.result || 'N/A' }}"
          echo "ëª¨ë¸ ë°°í¬: âŒ (í”„ë¡œë•ì…˜ í™˜ê²½ ì œê±°ë¨)"
        else
          echo "í•™ìŠµ ì‹¤í–‰: âŒ (ë¶ˆí•„ìš”)"
          echo "ì´ìœ : í˜„ìž¬ ëª¨ë¸ì´ ì¶©ë¶„ížˆ ì¢‹ìŒ"
        fi
        
        echo ""
        echo "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "ì»¤ë°‹ SHA: ${{ github.sha }}"
